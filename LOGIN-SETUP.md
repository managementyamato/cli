# ログイン設定ガイド

YA管理一覧システムのログイン機能の設定方法をまとめています。

## 📋 目次

1. [ログイン方法の種類](#ログイン方法の種類)
2. [従業員アカウントの作成](#従業員アカウントの作成)
3. [パスワードログインの設定](#パスワードログインの設定)
4. [Googleログインの設定](#googleログインの設定)
5. [ログイン方法の併用](#ログイン方法の併用)
6. [トラブルシューティング](#トラブルシューティング)

---

## ログイン方法の種類

このシステムは2つのログイン方法をサポートしています：

### 1. パスワードログイン（従来型）
- メールアドレスとパスワードでログイン
- システム内でパスワードを管理
- すぐに使用可能（追加設定不要）

### 2. Googleログイン（OAuth認証）
- Googleアカウントでログイン
- パスワード管理不要
- Google Cloud Consoleでの設定が必要

**どちらを選ぶべき？**
- **すぐに使いたい**: パスワードログイン
- **セキュリティ重視**: Googleログイン
- **両方使いたい**: 併用可能

---

## 従業員アカウントの作成

どちらのログイン方法でも、まず従業員マスタへの登録が必要です。

### 従業員の登録手順

1. システムにログイン（管理者権限）
2. メニューから「従業員マスタ」をクリック
3. 「新規登録」ボタンをクリック
4. 必要な情報を入力：

   **必須項目**
   - 従業員名
   - 所属エリア
   - メールアドレス（ログインに使用）

   **任意項目**
   - ナンバー（車両番号など）
   - メモ

5. **ログイン設定（パスワードログインを使う場合のみ）**
   - ユーザー名（通常はメールアドレスと同じ）
   - パスワード
   - 権限（admin: 管理者 / user: 一般ユーザー）

6. 「登録」ボタンをクリック

---

## パスワードログインの設定

### 特徴
✅ 追加設定不要ですぐに使える
✅ システム内で完結
❌ パスワード管理が必要

### 設定手順

#### 1. 従業員にログイン権限を付与

従業員マスタで従業員を編集する際に、以下を設定：

```
ユーザー名: user@example.com
パスワード: （安全なパスワードを設定）
権限: user または admin
```

#### 2. ログイン方法

1. http://localhost:8000/login.php にアクセス
2. メールアドレスを入力
3. パスワードを入力
4. 「ログイン」ボタンをクリック

### パスワードの変更

従業員マスタから該当の従業員を編集し、新しいパスワードを入力して保存してください。

---

## Googleログインの設定

### 特徴
✅ パスワード管理不要
✅ セキュリティが高い
✅ Googleアカウントで簡単ログイン
❌ 初回設定が必要（Google Cloud Console）

### 🚀 クイック設定（5分）

#### ステップ1: Google Cloud Consoleでの設定

1. **Google Cloud Console にアクセス**
   - https://console.cloud.google.com/
   - Googleアカウントでログイン

2. **プロジェクトを作成**
   - 画面上部の「プロジェクトを選択」→「新しいプロジェクト」
   - プロジェクト名: YA管理システム
   - 「作成」をクリック

3. **OAuth同意画面を設定**
   - 左メニュー: 「APIとサービス」→「OAuth同意画面」
   - User Type: 「外部」を選択 → 「作成」
   - アプリ名: YA管理一覧
   - ユーザーサポートメール: 自分のメールアドレス
   - デベロッパーの連絡先: 自分のメールアドレス
   - 「保存して次へ」を3回クリック

4. **OAuth 2.0 クライアントIDを作成**
   - 左メニュー: 「APIとサービス」→「認証情報」
   - 「認証情報を作成」→「OAuth クライアント ID」
   - アプリケーションの種類: **ウェブ アプリケーション**
   - 名前: YA管理システム
   - 承認済みのリダイレクト URI:
     ```
     http://localhost:8000/google-callback.php
     ```
   - 「作成」をクリック

5. **クライアントIDとシークレットをコピー**
   - 表示された「クライアントID」をコピー
   - 「クライアントシークレット」もコピー

#### ステップ2: システムでの設定

1. **設定ファイルを作成**
   ```bash
   cp google-config.json.template google-config.json
   ```

2. **設定情報を貼り付け**

   `google-config.json` を開いて、コピーした情報を貼り付け：
   ```json
   {
     "client_id": "ここにクライアントIDを貼り付け",
     "client_secret": "ここにクライアントシークレットを貼り付け",
     "redirect_uri": "http://localhost:8000/google-callback.php"
   }
   ```

#### ステップ3: テストユーザーの追加

1. Google Cloud Console に戻る
2. 「APIとサービス」→「OAuth同意画面」
3. 「テストユーザーを追加」をクリック
4. ログインに使用するGoogleアカウントのメールアドレスを入力
5. **重要**: このメールアドレスは従業員マスタに登録されている必要があります

#### ステップ4: ログイン方法

1. http://localhost:8000/login.php にアクセス
2. 「Googleでログイン」ボタンをクリック
3. Googleアカウントを選択
4. 権限を許可
5. 自動的にシステムにログイン

### 📚 詳細ガイド

より詳しい手順は以下を参照：
- **クイックスタート**: `GOOGLE-OAUTH-QUICKSTART.md`
- **詳細ガイド**: `GOOGLE-OAUTH-SETUP.md`

---

## ログイン方法の併用

パスワードログインとGoogleログインは同時に使用できます。

### 設定方法

1. **従業員マスタで設定**
   - 従業員にメールアドレスを登録（必須）
   - パスワードログインを使う場合は、パスワードと権限も設定
   - Googleログインを使う場合は、Google Cloud Consoleでテストユーザーに追加

2. **ログイン画面の表示**
   - パスワードログインフォームは常に表示
   - `google-config.json` が設定されている場合、「Googleでログイン」ボタンも表示

### 使い分けの例

| 従業員 | パスワード | Google | 用途 |
|--------|-----------|--------|------|
| 管理者A | ○ | ○ | 両方使える |
| 社員B | ✕ | ○ | Googleのみ |
| 外部C | ○ | ✕ | パスワードのみ |

---

## トラブルシューティング

### パスワードログインの問題

#### Q: ログインできない
**確認事項**:
- [ ] 従業員マスタにメールアドレスが登録されている
- [ ] パスワードが設定されている
- [ ] 権限（role）が設定されている
- [ ] メールアドレス・パスワードが正しい

**解決方法**:
1. 従業員マスタで該当ユーザーを確認
2. 必要に応じてパスワードを再設定

#### Q: 「写真アップロードが使えない」と表示される
**原因**: 従業員IDが設定されていない

**解決方法**:
1. 一度ログアウト
2. 再度ログイン（employee_idがセッションに設定される）

### Googleログインの問題

#### Q: 「Googleでログイン」ボタンが表示されない
**確認事項**:
- [ ] `google-config.json` が作成されている
- [ ] JSON形式が正しい（カンマ、クォーテーション）
- [ ] client_id と client_secret が入力されている

#### Q: 「このアプリは確認されていません」と表示される
**状況**: テストモードでは正常です

**対処方法**:
1. 「詳細」をクリック
2. 「（アプリ名）に移動（安全ではないページ）」をクリック

#### Q: 「このGoogleアカウントは登録されていません」エラー
**原因**: 従業員マスタにメールアドレスが未登録、またはテストユーザーに未追加

**解決方法**:
1. 従業員マスタでメールアドレスを確認・登録
2. Google Cloud Consoleでテストユーザーに追加

#### Q: 「アクセスがブロックされました」エラー
**原因**: テストユーザーに追加されていない

**解決方法**:
1. Google Cloud Console → OAuth同意画面
2. テストユーザーにメールアドレスを追加

---

## セキュリティのベストプラクティス

### パスワードログイン
- ✅ 強力なパスワードを使用（8文字以上、英数字記号混在）
- ✅ 定期的なパスワード変更
- ✅ 同じパスワードを複数のサービスで使い回さない

### Googleログイン
- ✅ 2段階認証を有効化（Googleアカウント）
- ✅ テストユーザーは必要な人のみ追加
- ✅ 本番環境では適切なドメインを設定

### 共通
- ✅ 離職者のアカウントは速やかに無効化
- ✅ 管理者権限は必要最小限に
- ✅ ログイン情報は他人と共有しない

---

## 本番環境での設定

### パスワードログイン
- 追加設定は不要（そのまま使用可能）

### Googleログイン
1. **redirect_uri を変更**

   `google-config.json`:
   ```json
   {
     "client_id": "...",
     "client_secret": "...",
     "redirect_uri": "https://your-domain.com/google-callback.php"
   }
   ```

2. **Google Cloud Consoleの設定を更新**
   - 「認証情報」→作成したクライアントIDを編集
   - 「承認済みのリダイレクト URI」に本番URLを追加:
     ```
     https://your-domain.com/google-callback.php
     ```

3. **100人以上使う場合**
   - OAuth同意画面の公開申請が必要
   - Googleの審査に数日〜数週間かかる場合があります

---

## 初期セットアップ

システムを初めて起動した場合は、セットアップが必要です。

### セットアップ手順

1. http://localhost:8000/setup.php にアクセス
2. 管理者情報を入力：
   - 名前
   - メールアドレス
   - パスワード
3. 「セットアップ完了」をクリック
4. 自動的にログイン画面にリダイレクト

これで管理者アカウントが作成され、ログインできるようになります。

---

## 将来の拡張機能（TODO）

### Googleドライブ連携（未実装）

アルコールチェック写真をGoogleドライブに自動アップロードする機能を実装予定です。

#### 必要な設定
1. **Google Cloud Console**
   - Google Drive API を有効化
   - OAuth 2.0 クライアントにスコープ追加:
     - `https://www.googleapis.com/auth/drive.file`（推奨）
     - または `https://www.googleapis.com/auth/drive`（フルアクセス）

2. **Googleドライブの準備**
   - 「アルコールチェック」フォルダを作成
   - フォルダIDをシステムに設定

3. **実装内容**
   - 写真アップロード時に自動でGoogleドライブに保存
   - ローカルには縮小版のみ保存（確認用）
   - Googleドライブの写真へのリンクを記録

#### メリット
- サーバーの容量を節約
- 写真を別途バックアップ不要
- Googleドライブから直接確認可能

**実装時期**: 未定（要望があれば実装）

---

## 関連ファイル

- `login.php`: ログイン画面
- `logout.php`: ログアウト処理
- `google-callback.php`: Google OAuth コールバック処理
- `google-oauth.php`: OAuth認証クライアント
- `config.php`: 認証ロジック
- `employees.php`: 従業員マスタ（アカウント管理）

---

## サポート

問題が解決しない場合は、以下を確認してください：

1. **セッション診断ツール** (管理者のみ)
   - http://localhost:8000/debug-session.php
   - セッション情報と写真アップロード機能の状態を確認

2. **ログファイル**
   - PHPのエラーログを確認
   - ブラウザのコンソールログを確認

3. **設定ファイル**
   - `google-config.json` のJSON形式が正しいか確認
   - `data.json` に従業員データが存在するか確認
